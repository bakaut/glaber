name: Docker Image CI build docker
on:
  push:
    branches:
    - 'build/**'
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare variables
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
        GLABER_BUILD_VERSION=$(cat glaber.version)
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        echo "GLABER_BUILD_VERSION=$GLABER_BUILD_VERSION" >> $GITHUB_ENV
        echo "TMG_TAG=$GLABER_BUILD_VERSION-$SHORT_SHA" >> $GITHUB_ENV
        echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV
        echo "REGISTRY=ghcr.io" >> $GITHUB_ENV

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2

    - name: Build temp glaber-server image
      id: glaber-server
      run: |
        BASE_IMAGE="$REGISTRY/$GITHUB_REPOSITORY/glaber-server"
        TMP_IMAGE="$BASE_IMAGE:$TMG_TAG"
        cd glaber-server
        docker build . -t $TMP_IMAGE --build-arg GLABER_BUILD_VERSION=$GLABER_BUILD_VERSION
        docker push $TMP_IMAGE

    - name: Build temp glaber-nginx image
      id: glaber-nginx
      run: |
        BASE_IMAGE="${{ env.REGISTRY }}/$GITHUB_REPOSITORY/glaber-nginx"
        TMP_IMAGE="$BASE_IMAGE:$TMG_TAG"
        cd glaber-nginx
        docker build . -t $TMP_IMAGE --build-arg GLABER_BUILD_VERSION=$GLABER_BUILD_VERSION
        docker push $TMP_IMAGE

    - name: Test glaber start
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2-utils
        export GLABER_BUILD_VERSION=$TMG_TAG
        ./glaber.sh start
